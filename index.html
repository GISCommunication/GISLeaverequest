<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GIS Leave Request Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 5px; width: 100%; cursor: pointer; font-size: 16px; }
    button:hover { background: #1a252f; }
    #loadingMessage { text-align: center; margin-top: 10px; color: #555; font-style: italic; }
  </style>
</head>
<body>
<div class="container">
  <h2>GEMS International School, Al Khail</h2>
  <h2>Leave Request Form</h2>

  <label for="email">Parent/Guardian Email registered with GIS</label>
  <input type="email" id="email" required>
  <button onclick="validateEmail()">Validate Email</button>
  <div id="loadingMessage"></div>

  <form id="leaveForm" action="https://docs.google.com/forms/d/e/1FAIpQLSdcnWetkfAFEOe_SmhsHyT7fOuW5tPuG_Bjzbv1FnM-l5m8_g/formResponse" method="POST" target="invisibleFrame">
    <div id="studentInfo" style="display: none;">

      <label for="studentName">Student Name</label>
      <select id="studentName" name="entry.1112781725" onchange="autofillDetails()" required></select>

      <input type="hidden" id="studentId" name="entry.102330296">
      <input type="hidden" id="grade" name="entry.468445493">
      <input type="hidden" id="section" name="entry.1428888703">

      <label for="leaveType">Type of Leave</label>
      <select id="leaveType" name="entry.722608314" required onchange="handleDismissalOption()">
        <option value="">Select</option>
        <option>Sick Leave</option>
        <option>Planned Leave</option>
        <option>Unplanned Leave</option>
        <option>Early Dismissal</option>
      </select>

      <div id="dismissalOptionContainer" style="display: none;">
        <label for="dismissalOption">Early Dismissal Plan</label>
        <select id="dismissalOptionSelect" name="entry.1010113884">
          <option value="">Select</option>
          <option>Parent/Guardian will pick up the student from school</option>
          <option>Student will leave on their own after early dismissal</option>
        </select>
      </div>

      <input type="hidden" id="dismissalOptionHidden" name="entry.1010113884">

      <label for="fromDate">From Date</label>
      <input type="date" id="fromDate" name="entry.1213409688" required>

      <label for="toDate">To Date</label>
      <input type="date" id="toDate" name="entry.88265946" required>

      <label for="reason">Reason <i>(If Early Dismissal, please mention time)</i></label>
      <textarea id="reason" name="entry.2006563853" rows="4" required></textarea>

      <input type="hidden" id="hiddenEmailField" name="entry.383074926" required>

      <button type="button" onclick="handleSubmit()">Submit</button>
    </div>
  </form>

  <iframe name="invisibleFrame" style="display:none;"></iframe>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbydNwIgNePZ5LBmfoH5OE9RkaZ_TjZDJcHqeuGUA1sXzAcxVqX8YkWKBrsRViZ6xlBD/exec';

let studentMap = {};

function validateEmail() {
  const email = document.getElementById('email').value.trim();
  const messageDiv = document.getElementById('loadingMessage');
  if (!email) return alert("Please enter your email.");

  messageDiv.textContent = "ðŸ”’ GIS takes safeguarding seriously. Please wait whilst we validate the email against our records...";

  fetch(`${API_URL}?email=${encodeURIComponent(email)}`)
    .then(res => res.json())
    .then(data => {
      messageDiv.textContent = "";
      if (!data.students || data.students.length === 0) return alert("No students found for this email.");

      const dropdown = document.getElementById('studentName');
      dropdown.innerHTML = '<option value="">Select Student</option>';
      studentMap = {}; // clear previous
      data.students.forEach(stu => {
        studentMap[stu.name] = stu;
        const option = document.createElement('option');
        option.value = stu.name;
        option.textContent = stu.name;
        dropdown.appendChild(option);
      });

      document.getElementById('hiddenEmailField').value = email;
      document.getElementById('studentInfo').style.display = 'block';
    })
    .catch(() => {
      messageDiv.textContent = "";
      alert("Error validating email.");
    });
}

function autofillDetails() {
  const name = document.getElementById('studentName').value;
  const student = studentMap[name];
  if (!student) return;

  document.getElementById('studentId').value = student.studentId;
  document.getElementById('grade').value = student.grade;
  document.getElementById('section').value = student.section;

  handleDismissalOption();
}

function handleDismissalOption() {
  const grade = document.getElementById('grade').value.trim();
  const leaveType = document.getElementById('leaveType').value;
  const isLowerGrade = ['PK', 'KG1', 'KG2', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5'].includes(grade);
  const isUpperGrade = ['Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'].includes(grade);

  const dismissalContainer = document.getElementById('dismissalOptionContainer');
  const dismissalHidden = document.getElementById('dismissalOptionHidden');
  const dismissalSelect = document.getElementById('dismissalOptionSelect');

  dismissalHidden.value = "";
  dismissalSelect.value = "";

  if (leaveType === 'Early Dismissal') {
    if (isLowerGrade) {
      alert("For PKâ€“Grade 5: Parent/Guardian will pick up the student from school.");
      dismissalContainer.style.display = "none";
      dismissalHidden.value = "Parent/Guardian will pick up the student from school";
    } else if (isUpperGrade) {
      dismissalContainer.style.display = "block";
    } else {
      dismissalContainer.style.display = "none";
    }
  } else {
    dismissalContainer.style.display = "none";
    dismissalHidden.value = "";
    dismissalSelect.value = "";
  }
}

function handleSubmit() {
  const leaveType = document.getElementById('leaveType').value;
  const isUpperGrade = ['Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'].includes(document.getElementById('grade').value.trim());

  if (!document.getElementById('studentName').value || !document.getElementById('fromDate').value || !document.getElementById('toDate').value || !document.getElementById('reason').value) {
    return alert("Please complete all required fields.");
  }

  if (leaveType === "Early Dismissal" && isUpperGrade && !document.getElementById('dismissalOptionSelect').value) {
    return alert("Please select the early dismissal plan.");
  }

  if (leaveType === "Early Dismissal" && isUpperGrade) {
    document.getElementById('dismissalOptionHidden').value = document.getElementById('dismissalOptionSelect').value;
  }

  alert("âœ… Your leave request has been submitted.");
  document.getElementById('leaveForm').submit();

  setTimeout(() => location.reload(), 3000);
}
</script>
</body>
</html>
