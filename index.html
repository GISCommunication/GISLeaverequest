<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GIS Leave Request Form</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
    .container { max-width: 600px; background: #fff; padding: 20px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 5px; width: 100%; cursor: pointer; font-size: 16px; }
    button:hover { background: #1a252f; }
  </style>
</head>
<body>
<div class="container">
  <h2>GEMS International School, Al Khail</h2>
  <h2>Leave Request Form</h2>

  <label for="email">Parent/Guardian Email</label>
  <input type="email" id="email" required>
  <button onclick="validateEmail()">Validate Email</button>

  <form id="leaveForm" style="display: none;">
    <label for="studentName">Student Name</label>
    <select id="studentName" onchange="autofillDetails()" required></select>

    <label for="studentId">Student ID</label>
    <input type="text" id="studentId" readonly required>

    <label for="grade">Grade</label>
    <input type="text" id="grade" readonly required>

    <label for="section">Section</label>
    <input type="text" id="section" readonly required>

    <label for="leaveType">Type of Leave</label>
    <select id="leaveType" required onchange="handleLeaveType()">
      <option value="">Select</option>
      <option>Sick Leave</option>
      <option>Planned Leave</option>
      <option>Unplanned Leave</option>
      <option>Early Dismissal</option>
    </select>

    <div id="dismissalContainer" style="display: none;"></div>

    <label for="fromDate">From Date</label>
    <input type="date" id="fromDate" required>

    <label for="toDate">To Date</label>
    <input type="date" id="toDate" required>

    <label for="reason">Reason <i>(If Early Dismissal, please mention time)</i></label>
    <textarea id="reason" required></textarea>

    <input type="hidden" id="hiddenEmail">
    <input type="hidden" id="dismissalPlan">

    <button type="submit">Submit</button>
  </form>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwDPoMtmgI8nPA4LhjYYKcai6O4CFaXo8oQR-UcZqfe9xfu9zU4fYHcfUAeQy9wTOCkXA/exec';
let studentMap = [];

function validateEmail() {
  const email = document.getElementById('email').value.trim();
  if (!email) return alert("Please enter an email.");

  fetch(`${API_URL}?email=${encodeURIComponent(email)}`)
    .then(res => res.json())
    .then(data => {
      if (!data.students || data.students.length === 0) return alert("No students found.");

      const dropdown = document.getElementById('studentName');
      dropdown.innerHTML = '<option value="">Select Student</option>';
      studentMap = data.students;

      data.students.forEach((stu, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = stu.name;
        dropdown.appendChild(opt);
      });

      document.getElementById('hiddenEmail').value = email;
      document.getElementById('leaveForm').style.display = 'block';
    });
}

function autofillDetails() {
  const idx = document.getElementById('studentName').value;
  if (idx === '') return;
  const student = studentMap[idx];
  document.getElementById('studentId').value = student.studentId;
  document.getElementById('grade').value = student.grade;
  document.getElementById('section').value = student.section;
  handleLeaveType();
}

function handleLeaveType() {
  const leaveType = document.getElementById('leaveType').value;
  const grade = document.getElementById('grade').value;
  const dismissalContainer = document.getElementById('dismissalContainer');
  const dismissalPlanInput = document.getElementById('dismissalPlan');

  dismissalContainer.innerHTML = '';
  dismissalPlanInput.value = '';

  if (leaveType !== 'Early Dismissal') return;

  const primaryGrades = ['PK','KG1','KG2','Grade 1','Grade 2','Grade 3','Grade 4','Grade 5'];
  const secondaryGrades = ['Grade 6','Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12'];

  if (primaryGrades.includes(grade)) {
    alert("For Primary students, Parent/Guardian will pick up the student from school.");
    dismissalPlanInput.value = "Parent/Guardian will pick up the student from school";
  } else if (secondaryGrades.includes(grade)) {
    dismissalContainer.style.display = 'block';
    dismissalContainer.innerHTML = `
      <label for="dismissalOption">Early Dismissal Plan</label>
      <select id="dismissalOption" required>
        <option value="">Select</option>
        <option>Parent/Guardian will pick up the student from school</option>
        <option>Student will leave on their own after early dismissal</option>
      </select>
    `;

    document.getElementById('dismissalOption').addEventListener('change', function () {
      dismissalPlanInput.value = this.value;
    });
  }
}

document.getElementById('leaveForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const payload = {
    email: document.getElementById('hiddenEmail').value,
    studentName: studentMap[document.getElementById('studentName').value].name,
    studentId: document.getElementById('studentId').value,
    grade: document.getElementById('grade').value,
    section: document.getElementById('section').value,
    leaveType: document.getElementById('leaveType').value,
    fromDate: document.getElementById('fromDate').value,
    toDate: document.getElementById('toDate').value,
    reason: document.getElementById('reason').value,
    dismissalPlan: document.getElementById('dismissalPlan').value || ''
  };

  if (payload.leaveType === 'Early Dismissal' && payload.grade.startsWith('Grade 6') === false && !payload.dismissalPlan) {
    alert("Dismissal plan must be selected or captured.");
    return;
  }

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  })
    .then(res => res.json())
    .then(resp => {
      alert("âœ… Leave request submitted successfully.");
      location.reload();
    })
    .catch(() => alert("Error submitting leave request."));
});
</script>
</body>
</html>
