<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GIS Leave Request Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; }
    label { display: block; margin-top: 15px; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 12px; background: #2c3e50; color: white; border: none; border-radius: 5px; width: 100%; cursor: pointer; font-size: 16px; }
    button:hover { background: #1a252f; }
    iframe { display: none; height: 0; border: none; }
    #loadingMessage { text-align: center; margin-top: 10px; color: #555; font-style: italic; }
  </style>
</head>
<body>
<div class="container">
  <h2>GEMS International School, Al Khail</h2>
  <h2>Leave Request Form</h2>

  <label for="email">Parent/Guardian Email registered with GIS</label>
  <input type="email" id="email" required>
  <button onclick="validateEmail()">Validate Email</button>
  <div id="loadingMessage"></div>

  <form id="leaveForm" target="invisibleFrame">
    <div id="studentInfo" style="display: none;">
      <label for="studentName">Student Name</label>
      <select id="studentName" onchange="autofillDetails()" required></select>

      <label for="studentId">Student ID</label>
      <input type="text" id="studentId" readonly required>

      <label for="grade">Grade</label>
      <input type="text" id="grade" readonly required>

      <label for="section">Section</label>
      <input type="text" id="section" readonly required>

      <label for="leaveType">Type of Leave</label>
      <select id="leaveType" required onchange="handleDismissalOption()">
        <option value="">Select</option>
        <option>Sick Leave</option>
        <option>Planned Leave</option>
        <option>Unplanned Leave</option>
        <option>Early Dismissal</option>
      </select>

      <div id="dismissalOptionContainer" style="display: none;">
        <label for="dismissalOption">Early Dismissal Plan</label>
        <select id="dismissalOption" required>
          <option value="">Select</option>
          <option value="Parent/Guardian will pick up the student from school">Parent/Guardian will pick up the student from school</option>
          <option value="Student will leave on their own after early dismissal">Student will leave on their own after early dismissal</option>
        </select>
      </div>

      <label for="fromDate">From Date</label>
      <input type="date" id="fromDate" required>

      <label for="toDate">To Date</label>
      <input type="date" id="toDate" required>

      <label for="reason">Reason <span style="font-weight: normal; font-style: italic;">(If Early Dismissal, please mention time)</span></label>
      <textarea id="reason" rows="4" required></textarea>

      <input type="hidden" id="hiddenEmailField" required>
      <input type="hidden" id="hiddenDismissalPlan">

      <button type="button" onclick="handleSubmit()">Submit</button>
    </div>
  </form>
  <iframe name="invisibleFrame" id="invisibleFrame"></iframe>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbydNwIgNePZ5LBmfoH5OE9RkaZ_TjZDJcHqeuGUA1sXzAcxVqX8YkWKBrsRViZ6xlBD/exec';

  function validateEmail() {
    const email = document.getElementById('email').value.trim();
    const messageDiv = document.getElementById('loadingMessage');

    if (!email) {
      alert("Please enter your email.");
      return;
    }

    messageDiv.textContent = "üîí GIS takes safeguarding very seriously. Please wait while we validate the email against our records...";

    fetch(`${API_URL}?email=${encodeURIComponent(email)}`)
      .then(res => res.json())
      .then(data => {
        messageDiv.textContent = "";

        if (!data.students || data.students.length === 0) {
          alert("No students found for this email.");
          return;
        }

        const dropdown = document.getElementById('studentName');
        dropdown.innerHTML = '<option value="">Select Student</option>';
        data.students.forEach(stu => {
          const option = document.createElement('option');
          option.value = JSON.stringify(stu);
          option.textContent = stu.name;
          dropdown.appendChild(option);
        });

        document.getElementById('hiddenEmailField').value = email;
        document.getElementById('studentInfo').style.display = 'block';
      })
      .catch(err => {
        messageDiv.textContent = "";
        alert("Error validating email.");
      });
  }

  function autofillDetails() {
    const selected = document.getElementById('studentName').value;
    if (!selected) return;
    const student = JSON.parse(selected);
    document.getElementById('grade').value = student.grade;
    document.getElementById('section').value = student.section;
    document.getElementById('studentId').value = student.studentId;
    handleDismissalOption();
  }

  function handleDismissalOption() {
    const grade = document.getElementById('grade').value.trim();
    const leaveType = document.getElementById('leaveType').value.trim();
    const dismissalContainer = document.getElementById('dismissalOptionContainer');
    const dismissalSelect = document.getElementById('dismissalOption');
    const hiddenDismissal = document.getElementById('hiddenDismissalPlan');

    const juniorGrades = ['PK', 'KG1', 'KG2', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5'];

    if (leaveType === 'Early Dismissal') {
      if (juniorGrades.includes(grade)) {
        alert("Parent/Guardian must pick up the student from school.");
        dismissalContainer.style.display = 'none';
        hiddenDismissal.value = 'Parent/Guardian will pick up the student from school';
      } else {
        dismissalContainer.style.display = 'block';
        hiddenDismissal.value = dismissalSelect.value;
      }
    } else {
      dismissalContainer.style.display = 'none';
      dismissalSelect.value = '';
      hiddenDismissal.value = '';
    }
  }

  function handleSubmit() {
    const requiredFields = ['studentName', 'studentId', 'grade', 'section', 'leaveType', 'fromDate', 'toDate', 'reason', 'hiddenEmailField'];
    for (let id of requiredFields) {
      if (!document.getElementById(id).value) {
        alert('Please fill in all fields before submitting.');
        return;
      }
    }

    const leaveType = document.getElementById('leaveType').value;
    const grade = document.getElementById('grade').value.trim();
    const dismissal = document.getElementById('dismissalOption');
    const hiddenDismissal = document.getElementById('hiddenDismissalPlan');

    if (leaveType === 'Early Dismissal' && !['PK','KG1','KG2','Grade 1','Grade 2','Grade 3','Grade 4','Grade 5'].includes(grade) && !dismissal.value) {
      alert("Please select the early dismissal plan.");
      return;
    } else if (leaveType === 'Early Dismissal' && !['PK','KG1','KG2','Grade 1','Grade 2','Grade 3','Grade 4','Grade 5'].includes(grade)) {
      hiddenDismissal.value = dismissal.value;
    }

    const payload = {
      email: document.getElementById('hiddenEmailField').value,
      studentName: JSON.parse(document.getElementById('studentName').value).name,
      studentId: document.getElementById('studentId').value,
      grade: document.getElementById('grade').value,
      section: document.getElementById('section').value,
      leaveType: leaveType,
      fromDate: document.getElementById('fromDate').value,
      toDate: document.getElementById('toDate').value,
      reason: document.getElementById('reason').value,
      dismissalPlan: hiddenDismissal.value
    };

    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      alert("‚úÖ Your leave request has been submitted. You will be notified via email.");
      setTimeout(() => window.location.reload(), 3000);
    })
    .catch(error => {
      alert("‚ùå There was an error submitting the form. Please try again.");
    });
  }
</script>
</body>
</html>
